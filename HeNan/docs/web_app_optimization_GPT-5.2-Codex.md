# Web 项目优化建议（GPT-5.2-Codex）

基于当前项目代码的快速审阅，给出可落地的优化方向与优先级建议。涉及的关键位置包括后端入口、数据库连接、路由层、导入服务、前端页面与脚本等。

## 1) 配置与安全
- **敏感信息外置**：数据库密码硬编码在 [web_app1/config.py](web_app1/config.py)。建议改为环境变量或配置文件注入，并在启动时校验必填项。
- **CORS范围收敛**：当前 `allow_origins=["*"]` 在 [web_app1/main.py](web_app1/main.py) 中过于宽松。建议按环境（开发/生产）区分白名单。
- **上传文件限制与校验**：已有限制大小，但缺少对MIME类型与文件内容一致性校验。建议在导入入口处加强校验并记录审计信息。

## 2) 数据库与性能
- **索引与查询优化**：
  - `drama_main(customer_code, drama_name)` 频繁查询（见 [web_app1/routers/dramas.py](web_app1/routers/dramas.py)），建议复合索引。
  - `copyright_content(media_name)` 在重复校验与去重中高频使用（见 [web_app1/services/import_service.py](web_app1/services/import_service.py)）。建议唯一或普通索引。
  - `video_scan_result(standard_episode_name)` 在模糊匹配与按需加载中高频使用，建议索引。
- **分页与字段裁剪**：列表接口返回字段较多，建议默认裁剪字段或提供 `fields` 参数，以减少网络和序列化成本。
- **批处理与事务边界**：导入逻辑目前每批次提交一次（已优化），建议进一步将“剧头插入 + 版权插入”置于同一事务范围，避免部分写入导致数据不一致。

## 3) 导入与异步任务
- **后台任务持久化**：导入任务状态存储在内存中（`_tasks`），服务重启会丢失。建议落库或使用Redis，支持断点与恢复。
- **任务并发与资源控制**：`_start_episode_generation_async()` 使用线程启动（见 [web_app1/services/import_service.py](web_app1/services/import_service.py)），建议限制并发、队列化，避免高峰期耗尽连接池。
- **错误可观测性**：将“子集生成失败”错误落库并关联 `task_id`，方便前端查询与复盘。

## 4) API设计与一致性
- **响应模型统一**：部分接口直接返回原始字典，部分使用 Pydantic 模型（见 [web_app1/models.py](web_app1/models.py) 与多个路由）。建议统一返回结构并确保字段命名一致。
- **参数校验与类型**：导入、更新时对日期、评分、时长等字段的校验还可以统一在 `Pydantic` 层完成，降低重复逻辑。

## 5) 前端体验与可维护性
- **大型单文件脚本拆分**：前端逻辑集中在 [web_app1/static/js/main.js](web_app1/static/js/main.js) 中，建议按模块拆分（客户、剧头、版权、导入），降低维护成本。
- **状态管理与渲染**：当前大量字符串拼接渲染，建议抽象成组件函数或模板，提升可读性与可测试性。
- **搜索与结果缓存**：可在前端缓存最近搜索结果，减少重复请求。

## 6) 导出与文件处理
- **导出路径与内存**：Excel 导出通过 `BytesIO` 生成（见 [web_app1/routers/dramas.py](web_app1/routers/dramas.py)）。大文件建议切换到流式写入或分块导出。
- **导出模板复用**：多个客户导出模板逻辑分散，建议抽象模板/渲染层，减少重复逻辑与维护成本。

## 7) 日志与监控
- **统一日志**：当前异常多为 `HTTPException` + `detail`。建议引入结构化日志（请求ID、任务ID、客户代码）并落地到日志文件。
- **性能监控**：对导入、导出、匹配等耗时操作记录耗时指标，便于发现瓶颈。

## 8) 代码一致性与复用
- **重复逻辑抽取**：`build_drama_props` 与 `build_episodes` 相关逻辑在多个模块出现，建议集中在一个服务层。
- **配置驱动增强**：客户配置已经比较完整，建议把更多分支逻辑移入配置（例如字段映射、默认值、格式化规则）。

## 建议优先级
1. **高优先级**：配置外置、索引优化、任务持久化、导出内存优化
2. **中优先级**：前端模块化、统一响应模型、日志增强
3. **低优先级**：UI重构、细粒度字段裁剪与缓存优化

> 以上建议基于当前代码结构与功能表现。若需要，我可以分步骤落地改造并提供执行计划。